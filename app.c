#include "app.h"           // –ó–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–π —Ñ–∞–π–ª —Å –æ–±—ä—è–≤–ª–µ–Ω–∏–µ–º run_app()
#include "queue.h"         // –ó–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–π —Ñ–∞–π–ª –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ—á–µ—Ä–µ–¥—å—é
#include "number_io.h"     // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –≤–≤–æ–¥–∞/–≤—ã–≤–æ–¥–∞ —á–∏—Å–µ–ª

// –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ –∑–∞–≥–æ–ª–æ–≤–æ—á–Ω—ã–µ —Ñ–∞–π–ª—ã C
#include <stdio.h>         // –í–≤–æ–¥-–≤—ã–≤–æ–¥ (printf, scanf, fopen –∏ –¥—Ä.)
#include <stdlib.h>        // –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ (malloc, free, rand, srand)
#include <string.h>        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ —Å—Ç—Ä–æ–∫–∞–º–∏ (strcmp, strcspn)
#include <time.h>          // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º (clock, time)
#include <locale.h>        // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ª–æ–∫–∞–ª–∏ (setlocale)

// –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–π
#ifdef _WIN32
#include <direct.h>    // –¥–ª—è _mkdir
#else
#include <sys/stat.h>  // –¥–ª—è mkdir
#include <sys/types.h>
#endif

// –£—Å–ª–æ–≤–Ω–∞—è –∫–æ–º–ø–∏–ª—è—Ü–∏—è –¥–ª—è Windows
#ifdef _WIN32
#include <windows.h>       // Windows API –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–Ω—Å–æ–ª–∏ (SetConsoleOutputCP)
#endif

/*
 * –ü—Ä–æ—Ç–æ—Ç–∏–ø—ã –≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π (forward declarations)
 * –≠—Ç–∏ —Ñ—É–Ω–∫—Ü–∏–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω—ã –Ω–∏–∂–µ –∏ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –≤ run_app()
 */
void handle_file_mode(const char *filename);      // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏
void handle_sort_once(void);                      // –†–∞–∑–æ–≤–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –æ—á–µ—Ä–µ–¥–∏
void handle_benchmark(void);                      // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–æ–∫
void handle_edit_element(void);                   // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –æ—á–µ—Ä–µ–¥–∏
void handle_queue_operations(void);               // –û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –æ—á–µ—Ä–µ–¥—å—é
void print_queue_stats(const Queue *q);           // –í—ã–≤–æ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –æ—á–µ—Ä–µ–¥–∏
void benchmark_automated(void);                   // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
int safe_scanf_int(int *value);                   // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤–≤–æ–¥ —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞
int safe_scanf_size_t(size_t *value);             // –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤–≤–æ–¥ size_t

/*
 * –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
 * argc - –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
 * argv - –º–∞—Å—Å–∏–≤ —Å—Ç—Ä–æ–∫-–∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: 0 –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏
 */
int run_app(int argc, char *argv[])
{
    /*
     * –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ –∫–æ–Ω—Å–æ–ª–∏ –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–∏–º–≤–æ–ª–æ–≤
     * –í Windows –∏—Å–ø–æ–ª—å–∑—É–µ–º WinAPI, –≤ Unix - setlocale
     */
    #ifdef _WIN32
    // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–æ–¥–æ–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É –∫–æ–Ω—Å–æ–ª–∏ –≤ UTF-8 (65001)
    SetConsoleOutputCP(65001);  // –î–ª—è –≤—ã–≤–æ–¥–∞
    SetConsoleCP(65001);        // –î–ª—è –≤–≤–æ–¥–∞
    #else
    // –í Unix-—Å–∏—Å—Ç–µ–º–∞—Ö –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –ª–æ–∫–∞–ª–∏–∑–∞—Ü–∏–∏
    setlocale(LC_ALL, "Russian");
    #endif
    
    /*
     * –û–±—Ä–∞–±–æ—Ç–∫–∞ –∞—Ä–≥—É–º–µ–Ω—Ç–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
     * –§–æ—Ä–º–∞—Ç: program --file filename.txt
     */
    if (argc == 3 && strcmp(argv[1], "--file") == 0) {
        handle_file_mode(argv[2]);  // –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–æ–º
        return 0;  // –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ–≥—Ä–∞–º–º—É –ø–æ—Å–ª–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞
    }
    
    /*
     * –§–æ—Ä–º–∞—Ç: program --benchmark-auto
     */
    if (argc == 2 && strcmp(argv[1], "--benchmark-auto") == 0) {
        benchmark_automated();  // –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        return 0;
    }

    /*
     * –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Ä–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã —Å –∫–æ–Ω—Å–æ–ª—å–Ω—ã–º –º–µ–Ω—é
     */
    printf("–ü—Ä–æ–≥—Ä–∞–º–º–∞ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –æ—á–µ—Ä–µ–¥—å—é –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–æ–π\n");
    printf("============================================\n");

    int done = 0;  // –§–ª–∞–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–∞–º–º—ã
    while (!done) {
        // –í—ã–≤–æ–¥ –≥–ª–∞–≤–Ω–æ–≥–æ –º–µ–Ω—é
        printf("\n–ú–µ–Ω—é:\n");
        printf("1 - –°–æ–∑–¥–∞—Ç—å –æ—á–µ—Ä–µ–¥—å –∏ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å (–º–µ—Ç–æ–¥ –ø—Ä—è–º–æ–≥–æ –≤—ã–±–æ—Ä–∞)\n");
        printf("2 - –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–µ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–æ–∫ (–æ—á–µ—Ä–µ–¥—å)\n");
        printf("3 - –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç –æ—á–µ—Ä–µ–¥–∏\n");
        printf("4 - –û—Å–Ω–æ–≤–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å –æ—á–µ—Ä–µ–¥—å—é\n");
        printf("5 - –†–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–æ–º\n");
        printf("0 - –í—ã—Ö–æ–¥\n> ");

        // –ß—Ç–µ–Ω–∏–µ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
        int choice;
        if (!safe_scanf_int(&choice)) {
            printf("–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\n");
            continue;  // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∏—Ç–µ—Ä–∞—Ü–∏—é –ø—Ä–∏ –æ—à–∏–±–∫–µ –≤–≤–æ–¥–∞
        }
        
        // –û—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–∞ –≤–≤–æ–¥–∞ –æ—Ç –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤ (–≤–∫–ª—é—á–∞—è '\n')
        int ch;
        while ((ch = getchar()) != '\n' && ch != EOF) {}

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        switch (choice) {
        case 1:
            handle_sort_once();  // –ü—É–Ω–∫—Ç 1: –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
            break;
        case 2:
            handle_benchmark();  // –ü—É–Ω–∫—Ç 2: —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤
            break;
        case 3:
            handle_edit_element();  // –ü—É–Ω–∫—Ç 3: —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞
            break;
        case 4:
            handle_queue_operations();  // –ü—É–Ω–∫—Ç 4: –±–∞–∑–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
            break;
        case 5:
            {
                // –ü—É–Ω–∫—Ç 5: —Ä–∞–±–æ—Ç–∞ —Å —Ñ–∞–π–ª–æ–º
                char filename[256];  // –ë—É—Ñ–µ—Ä –¥–ª—è –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞
                printf("–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Ñ–∞–π–ª–∞: ");
                if (fgets(filename, sizeof(filename), stdin) == NULL) {
                    printf("–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞ –∏–º–µ–Ω–∏ —Ñ–∞–π–ª–∞.\n");
                    break;
                }
                // –£–¥–∞–ª–µ–Ω–∏–µ —Å–∏–º–≤–æ–ª–∞ –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏ –∏–∑ fgets
                filename[strcspn(filename, "\n")] = 0;
                if (strlen(filename) == 0) {
                    printf("–ò–º—è —Ñ–∞–π–ª–∞ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.\n");
                    break;
                }
                handle_file_mode(filename);
            }
            break;
        case 0:
            done = 1;  // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ñ–ª–∞–≥–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
            printf("–í—ã—Ö–æ–¥ –∏–∑ –ø—Ä–æ–≥—Ä–∞–º–º—ã.\n");
            break;
        default:
            printf("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –ø—É–Ω–∫—Ç –º–µ–Ω—é.\n");
            break;
        }

        // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã
        if (!done) {
            printf("\n–í–µ—Ä–Ω—É—Ç—å—Å—è –≤ –º–µ–Ω—é? (y/n): ");
            int ans = getchar();
            while ((ch = getchar()) != '\n' && ch != EOF) {}
            if (ans != 'y' && ans != 'Y')
                done = 1;  // –í—ã—Ö–æ–¥, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤–≤–µ–ª –Ω–µ 'y' –∏–ª–∏ 'Y'
        }
    }

    return 0;  // –£—Å–ø–µ—à–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–∞–º–º—ã
}

/*
 * –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤–≤–æ–¥ —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –æ—à–∏–±–æ–∫
 * value - —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: 1 –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –≤–≤–æ–¥–µ, 0 –ø—Ä–∏ –æ—à–∏–±–∫–µ
 */
int safe_scanf_int(int *value)
{
    int result = scanf("%d", value);  // –ü–æ–ø—ã—Ç–∫–∞ —á—Ç–µ–Ω–∏—è —Ü–µ–ª–æ–≥–æ —á–∏—Å–ª–∞
    if (result != 1) {  // –ï—Å–ª–∏ –≤–≤–µ–¥–µ–Ω–æ –Ω–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
        int ch;
        // –û—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–∞ –≤–≤–æ–¥–∞ –æ—Ç –æ—à–∏–±–æ—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        while ((ch = getchar()) != '\n' && ch != EOF) {}
        return 0;  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –æ—à–∏–±–∫—É
    }
    return 1;  // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —É—Å–ø–µ—Ö
}

/*
 * –ë–µ–∑–æ–ø–∞—Å–Ω—ã–π –≤–≤–æ–¥ –∑–Ω–∞—á–µ–Ω–∏—è —Ç–∏–ø–∞ size_t
 * value - —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: 1 –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–º –≤–≤–æ–¥–µ, 0 –ø—Ä–∏ –æ—à–∏–±–∫–µ
 */
int safe_scanf_size_t(size_t *value)
{
    int result = scanf("%zu", value);  // %zu - —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ç–æ—Ä –¥–ª—è size_t
    if (result != 1) {
        int ch;
        while ((ch = getchar()) != '\n' && ch != EOF) {}
        return 0;
    }
    return 1;
}

/*
 * –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–æ–º
 * filename - –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏/—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
 */
void handle_file_mode(const char *filename)
{
    // –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –∏–∑ —Ñ–∞–π–ª–∞
    int *prev_orig = NULL, *prev_sorted = NULL;
    size_t prev_orig_n = 0, prev_sorted_n = 0;

    /*
     * –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ä–∞–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞
     * load_previous_rows –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∞ –≤ number_io.c
     */
    if (load_previous_rows(filename, &prev_orig, &prev_orig_n,
                          &prev_sorted, &prev_sorted_n) == 0 &&
        prev_orig && prev_orig_n > 0) {
        // –í—ã–≤–æ–¥ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
        printf("\n–†–∞–Ω–µ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Ñ–∞–π–ª–∞ \"%s\":\n", filename);
        printf("–ü—Ä–µ–¥—ã–¥—É—â–∏–π –≤–≤–µ–¥–µ–Ω–Ω—ã–π —Ä—è–¥:\n");
        print_int_array(prev_orig, prev_orig_n);

        if (prev_sorted && prev_sorted_n > 0) {
            printf("–ü—Ä–µ–¥—ã–¥—É—â–∏–π –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä—è–¥:\n");
            print_int_array(prev_sorted, prev_sorted_n);
        }
    } else {
        // –§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—É—Å—Ç
        printf("–§–∞–π–ª \"%s\" –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –ø—É—Å—Ç. –ë—É–¥–µ—Ç —Å–æ–∑–¥–∞–Ω –Ω–æ–≤—ã–π —Ñ–∞–π–ª.\n",
               filename);
    }

    // –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏, –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞
    free(prev_orig);
    free(prev_sorted);

    /*
     * –†–∞–±–æ—Ç–∞ —Å –æ—á–µ—Ä–µ–¥—å—é: —Å–æ–∑–¥–∞–Ω–∏–µ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
     */
    Queue q;
    queue_init(&q);  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—É—Å—Ç–æ–π –æ—á–µ—Ä–µ–¥–∏

    printf("\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —á–∏—Å–µ–ª —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª:\n> ");
    int *numbers = NULL;
    size_t count = read_ints_from_stdin(&numbers);  // –ß—Ç–µ–Ω–∏–µ —á–∏—Å–µ–ª –∏–∑ stdin
    
    if (count == 0 || !numbers) {
        printf("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —á–∏—Å–ª–∞.\n");
        queue_free(&q);
        free(numbers);
        return;
    }

    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏ —Å—á–∏—Ç–∞–Ω–Ω—ã–º–∏ —á–∏—Å–ª–∞–º–∏
    for (size_t i = 0; i < count; ++i) {
        if (queue_push(&q, numbers[i]) != 0) {
            printf("–û—à–∏–±–∫–∞: –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –ø–∞–º—è—Ç–∏ –¥–ª—è –æ—á–µ—Ä–µ–¥–∏.\n");
            free(numbers);
            queue_free(&q);
            return;
        }
    }

    printf("\n–°–æ–∑–¥–∞–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å:\n");
    queue_print(&q);

    /*
     * –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∫–æ–ø–∏–∏ –æ—á–µ—Ä–µ–¥–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ –ø–æ—Ä—è–¥–∫–∞
     */
    Queue *q_copy = queue_copy(&q);  // –°–æ–∑–¥–∞–Ω–∏–µ –≥–ª—É–±–æ–∫–æ–π –∫–æ–ø–∏–∏
    if (!q_copy) {
        printf("–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è –æ—á–µ—Ä–µ–¥–∏.\n");
        free(numbers);
        queue_free(&q);
        return;
    }

    printf("\n–°–æ—Ä—Ç–∏—Ä—É–µ–º –æ—á–µ—Ä–µ–¥—å –º–µ—Ç–æ–¥–æ–º –ø—Ä—è–º–æ–≥–æ –≤—ã–±–æ—Ä–∞...\n");
    queue_selection_sort(q_copy);  // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∫–æ–ø–∏–∏ –æ—á–µ—Ä–µ–¥–∏

    // –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    printf("\n–ò—Å—Ö–æ–¥–Ω–∞—è –æ—á–µ—Ä–µ–¥—å:\n");
    queue_print(&q);
    printf("–û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å:\n");
    queue_print(q_copy);

    /*
     * –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ —Ñ–∞–π–ª
     * –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –æ—á–µ—Ä–µ–¥—å –≤ –º–∞—Å—Å–∏–≤ –¥–ª—è —É–¥–æ–±–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
     */
    int *orig_array = (int*)malloc(q.size * sizeof(int));
    int *sorted_array = (int*)malloc(q_copy->size * sizeof(int));
    
    if (orig_array && sorted_array) {
        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –∏—Å—Ö–æ–¥–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ –≤ –º–∞—Å—Å–∏–≤
        QueueNode *node = q.head;
        size_t i = 0;
        while (node) {
            orig_array[i++] = node->value;
            node = node->next;
        }
        
        // –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ –æ—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ –≤ –º–∞—Å—Å–∏–≤
        node = q_copy->head;
        i = 0;
        while (node) {
            sorted_array[i++] = node->value;
            node = node->next;
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ —Ñ–∞–π–ª
        if (save_rows(filename, orig_array, q.size, sorted_array, q_copy->size) != 0) {
            printf("–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–∞–π–ª \"%s\".\n", filename);
        } else {
            printf("–î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ —Ñ–∞–π–ª \"%s\".\n", filename);
        }
    } else {
        printf("–û—à–∏–±–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è.\n");
    }
    
    /*
     * –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –≤—ã–¥–µ–ª–µ–Ω–Ω—ã—Ö —Ä–µ—Å—É—Ä—Å–æ–≤
     */
    free(orig_array);
    free(sorted_array);
    free(numbers);
    queue_free(&q);
    queue_free(q_copy);
    free(q_copy);  // –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ —Å–∞–º–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã Queue (–Ω–µ –ø—É—Ç–∞—Ç—å —Å queue_free)
}

/*
 * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ–¥–Ω–æ–∫—Ä–∞—Ç–Ω–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –æ—á–µ—Ä–µ–¥–∏
 */
void handle_sort_once(void)
{
    Queue q;
    queue_init(&q);

    printf("–í–≤–µ–¥–∏—Ç–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª:\n> ");
    int *numbers = NULL;
    size_t count = read_ints_from_stdin(&numbers);
    
    if (count == 0 || !numbers) {
        printf("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —á–∏—Å–ª–∞.\n");
        queue_free(&q);
        free(numbers);
        return;
    }

    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–∏
    for (size_t i = 0; i < count; ++i) {
        if (queue_push(&q, numbers[i]) != 0) {
            printf("–û—à–∏–±–∫–∞: –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –ø–∞–º—è—Ç–∏ –¥–ª—è –æ—á–µ—Ä–µ–¥–∏.\n");
            free(numbers);
            queue_free(&q);
            return;
        }
    }

    printf("\n–ò—Å—Ö–æ–¥–Ω–∞—è –æ—á–µ—Ä–µ–¥—å:\n");
    queue_print(&q);

    // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –∏—Å—Ö–æ–¥–Ω–æ–π –æ—á–µ—Ä–µ–¥–∏ (–∏–∑–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ –º–µ—Å—Ç–µ)
    queue_selection_sort(&q);

    printf("–û—Ç—Å–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å (–º–µ—Ç–æ–¥ –ø—Ä—è–º–æ–≥–æ –≤—ã–±–æ—Ä–∞):\n");
    queue_print(&q);

    // –û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏
    free(numbers);
    queue_free(&q);
}

/*
 * –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –æ—á–µ—Ä–µ–¥–∏ –ø–æ –∏–Ω–¥–µ–∫—Å—É
 */
void handle_edit_element(void)
{
    Queue q;
    queue_init(&q);

    printf("–í–≤–µ–¥–∏—Ç–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª:\n> ");
    int *numbers = NULL;
    size_t count = read_ints_from_stdin(&numbers);
    
    if (count == 0 || !numbers) {
        printf("–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å —á–∏—Å–ª–∞.\n");
        queue_free(&q);
        free(numbers);
        return;
    }

    for (size_t i = 0; i < count; ++i) {
        if (queue_push(&q, numbers[i]) != 0) {
            printf("–û—à–∏–±–∫–∞: –Ω–µ —Ö–≤–∞—Ç–∞–µ—Ç –ø–∞–º—è—Ç–∏ –¥–ª—è –æ—á–µ—Ä–µ–¥–∏.\n");
            free(numbers);
            queue_free(&q);
            return;
        }
    }

    printf("\n–¢–µ–∫—É—â–∞—è –æ—á–µ—Ä–µ–¥—å (%zu —ç–ª–µ–º–µ–Ω—Ç–æ–≤):\n", q.size);
    queue_print(&q);

    // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≤–æ–∑–º–æ–∂–Ω–æ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ—á–µ—Ä–µ–¥—å –Ω–µ –ø—É—Å—Ç–∞
    if (q.size > 0) {
        size_t index;
        int new_value;
        
        // –í–≤–æ–¥ –∏–Ω–¥–µ–∫—Å–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (0-based)
        printf("–í–≤–µ–¥–∏—Ç–µ –∏–Ω–¥–µ–∫—Å —ç–ª–µ–º–µ–Ω—Ç–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (0-%zu): ", q.size - 1);
        if (!safe_scanf_size_t(&index)) {
            printf("–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞ –∏–Ω–¥–µ–∫—Å–∞.\n");
            free(numbers);
            queue_free(&q);
            return;
        }
        
        // –í–≤–æ–¥ –Ω–æ–≤–æ–≥–æ –∑–Ω–∞—á–µ–Ω–∏—è
        printf("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ");
        if (!safe_scanf_int(&new_value)) {
            printf("–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞ –∑–Ω–∞—á–µ–Ω–∏—è.\n");
            free(numbers);
            queue_free(&q);
            return;
        }

        // –ü–æ–ø—ã—Ç–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        if (queue_edit_at(&q, index, new_value) == 0) {
            printf("–≠–ª–µ–º–µ–Ω—Ç —É—Å–ø–µ—à–Ω–æ –∏–∑–º–µ–Ω–µ–Ω. –ù–æ–≤–∞—è –æ—á–µ—Ä–µ–¥—å:\n");
            queue_print(&q);
        } else {
            printf("–û—à–∏–±–∫–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π –∏–Ω–¥–µ–∫—Å.\n");
        }
    }

    free(numbers);
    queue_free(&q);
}

/*
 * –ú–µ–Ω—é –æ—Å–Ω–æ–≤–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –æ—á–µ—Ä–µ–¥—å—é
 */
void handle_queue_operations(void)
{
    Queue q;
    queue_init(&q);
    
    int done = 0;
    while (!done) {
        // –ü–æ–¥–º–µ–Ω—é –æ–ø–µ—Ä–∞—Ü–∏–π —Å –æ—á–µ—Ä–µ–¥—å—é
        printf("\n–û–ø–µ—Ä–∞—Ü–∏–∏ —Å –æ—á–µ—Ä–µ–¥—å—é:\n");
        printf("1 - –î–æ–±–∞–≤–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç\n");
        printf("2 - –£–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç (–∏–∑ –Ω–∞—á–∞–ª–∞)\n");
        printf("3 - –í—ã–≤–µ—Å—Ç–∏ –æ—á–µ—Ä–µ–¥—å\n");
        printf("4 - –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —ç–ª–µ–º–µ–Ω—Ç\n");
        printf("5 - –û—á–∏—Å—Ç–∏—Ç—å –æ—á–µ—Ä–µ–¥—å\n");
        printf("6 - –í—ã–≤–µ—Å—Ç–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É\n");
        printf("0 - –ù–∞–∑–∞–¥\n> ");
        
        int choice;
        if (!safe_scanf_int(&choice)) {
            printf("–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.\n");
            continue;
        }
        getchar();  // –°—á–∏—Ç—ã–≤–∞–Ω–∏–µ '\n' –ø–æ—Å–ª–µ —á–∏—Å–ª–∞
        
        switch (choice) {
        case 1: {
            // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –≤ –∫–æ–Ω–µ—Ü –æ—á–µ—Ä–µ–¥–∏
            int value;
            printf("–í–≤–µ–¥–∏—Ç–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ");
            if (!safe_scanf_int(&value)) {
                printf("–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞ –∑–Ω–∞—á–µ–Ω–∏—è.\n");
                break;
            }
            getchar();
            if (queue_push(&q, value) == 0) {
                printf("–≠–ª–µ–º–µ–Ω—Ç %d –¥–æ–±–∞–≤–ª–µ–Ω.\n", value);
            } else {
                printf("–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è.\n");
            }
            break;
        }
        case 2: {
            // –£–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –∏–∑ –Ω–∞—á–∞–ª–∞ –æ—á–µ—Ä–µ–¥–∏ (FIFO)
            int value;
            if (queue_pop(&q, &value) == 0) {
                printf("–£–¥–∞–ª–µ–Ω —ç–ª–µ–º–µ–Ω—Ç: %d\n", value);
            } else {
                printf("–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞.\n");
            }
            break;
        }
        case 3:
            // –í—ã–≤–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –æ—á–µ—Ä–µ–¥–∏
            printf("–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –æ—á–µ—Ä–µ–¥–∏:\n");
            queue_print(&q);
            break;
        case 4: {
            // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–æ –∏–Ω–¥–µ–∫—Å—É
            if (q.size == 0) {
                printf("–û—á–µ—Ä–µ–¥—å –ø—É—Å—Ç–∞.\n");
                break;
            }
            size_t index;
            int new_value;
            printf("–í–≤–µ–¥–∏—Ç–µ –∏–Ω–¥–µ–∫—Å (0-%zu): ", q.size - 1);
            if (!safe_scanf_size_t(&index)) {
                printf("–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞ –∏–Ω–¥–µ–∫—Å–∞.\n");
                break;
            }
            printf("–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: ");
            if (!safe_scanf_int(&new_value)) {
                printf("–û—à–∏–±–∫–∞ –≤–≤–æ–¥–∞ –∑–Ω–∞—á–µ–Ω–∏—è.\n");
                break;
            }
            getchar();
            if (queue_edit_at(&q, index, new_value) == 0) {
                printf("–≠–ª–µ–º–µ–Ω—Ç –∏–∑–º–µ–Ω–µ–Ω.\n");
            } else {
                printf("–ù–µ–≤–µ—Ä–Ω—ã–π –∏–Ω–¥–µ–∫—Å.\n");
            }
            break;
        }
        case 5:
            // –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –æ—á–µ—Ä–µ–¥–∏
            queue_free(&q);
            queue_init(&q);
            printf("–û—á–µ—Ä–µ–¥—å –æ—á–∏—â–µ–Ω–∞.\n");
            break;
        case 6:
            // –í—ã–≤–æ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            print_queue_stats(&q);
            break;
        case 0:
            done = 1;  // –í–æ–∑–≤—Ä–∞—Ç –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é
            break;
        default:
            printf("–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è.\n");
            break;
        }
    }
    
    queue_free(&q);  // –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏ –ø–µ—Ä–µ–¥ –≤—ã—Ö–æ–¥–æ–º
}

/*
 * –í—ã–≤–æ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ–± –æ—á–µ—Ä–µ–¥–∏
 * q - —É–∫–∞–∑–∞—Ç–µ–ª—å –Ω–∞ –æ—á–µ—Ä–µ–¥—å (–Ω–µ –∏–∑–º–µ–Ω—è–µ—Ç—Å—è)
 */
void print_queue_stats(const Queue *q)
{
    printf("\n–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—á–µ—Ä–µ–¥–∏:\n");
    printf("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: %zu\n", q->size);
    printf("–°–æ—Å—Ç–æ—è–Ω–∏–µ: %s\n", queue_is_empty(q) ? "–ø—É—Å—Ç–∞" : "–Ω–µ –ø—É—Å—Ç–∞");
    
    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –Ω–µ–ø—É—Å—Ç–æ–π –æ—á–µ—Ä–µ–¥–∏
    if (!queue_is_empty(q)) {
        printf("–ü–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç: %d\n", q->head->value);
        printf("–ü–æ—Å–ª–µ–¥–Ω–∏–π —ç–ª–µ–º–µ–Ω—Ç: %d\n", q->tail->value);
        printf("–°–æ–¥–µ—Ä–∂–∏–º–æ–µ: ");
        queue_print(q);
    }
}

/*
 * –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–æ–∫
 */
void handle_benchmark(void)
{
    size_t n;
    printf("–í–≤–µ–¥–∏—Ç–µ —Ä–∞–∑–º–µ—Ä —Ç–µ—Å—Ç–æ–≤–æ–π –æ—á–µ—Ä–µ–¥–∏ (–Ω–∞–ø—Ä–∏–º–µ—Ä, 10000): ");
    if (!safe_scanf_size_t(&n) || n == 0) {
        printf("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ä–∞–∑–º–µ—Ä.\n");
        return;
    }
    getchar();  // –û—á–∏—Å—Ç–∫–∞ –±—É—Ñ–µ—Ä–∞

    // –°–æ–∑–¥–∞–Ω–∏–µ –¥–≤—É—Ö –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –æ—á–µ—Ä–µ–¥–µ–π –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    Queue q1, q2;
    queue_init(&q1);
    queue_init(&q2);

    // –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥–µ–π –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º–∏ —Å–ª—É—á–∞–π–Ω—ã–º–∏ —á–∏—Å–ª–∞–º–∏
    printf("–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º %zu —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª...\n", n);
    srand((unsigned)time(NULL));  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª
    for (size_t i = 0; i < n; ++i) {
        int val = rand() % 1000000;  // –ß–∏—Å–ª–∞ –æ—Ç 0 –¥–æ 999999
        queue_push(&q1, val);
        queue_push(&q2, val);
    }

    /*
     * –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –≤—ã–±–æ—Ä–æ–º
     */
    printf("–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –≤—ã–±–æ—Ä–æ–º...\n");
    clock_t start = clock();  // –ó–∞—Å–µ–∫–∞–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞
    queue_selection_sort(&q1);
    clock_t end = clock();    // –ó–∞—Å–µ–∫–∞–µ–º –≤—Ä–µ–º—è –æ–∫–æ–Ω—á–∞–Ω–∏—è
    double t_selection = (double)(end - start) / CLOCKS_PER_SEC;

    /*
     * –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±—ã—Å—Ç—Ä–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
     */
    printf("–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±—ã—Å—Ç—Ä–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏...\n");
    start = clock();
    queue_quick_sort(&q2);
    end = clock();
    double t_quick = (double)(end - start) / CLOCKS_PER_SEC;

    /*
     * –í—ã–≤–æ–¥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
     */
    printf("\n–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–ª—è –æ—á–µ—Ä–µ–¥–∏ –∏–∑ %zu —ç–ª–µ–º–µ–Ω—Ç–æ–≤:\n", n);
    printf("–ú–µ—Ç–æ–¥ –ø—Ä—è–º–æ–≥–æ –≤—ã–±–æ—Ä–∞: %.6f —Å–µ–∫.\n", t_selection);
    printf("–ë—ã—Å—Ç—Ä–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ (–•–æ–∞—Ä–∞): %.6f —Å–µ–∫.\n", t_quick);
    printf("–û—Ç–Ω–æ—à–µ–Ω–∏–µ —Å–∫–æ—Ä–æ—Å—Ç–µ–π: %.2f:1 (–±—ã—Å—Ç—Ä–∞—è –±—ã—Å—Ç—Ä–µ–µ –≤ %.2f —Ä–∞–∑)\n", 
           t_selection / t_quick, t_selection / t_quick);

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤ —Ñ–∞–π–ª
    FILE *f = fopen("benchmark_results.txt", "a");  // "a" - –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≤ –∫–æ–Ω–µ—Ü —Ñ–∞–π–ª–∞
    if (f) {
        fprintf(f, "%zu %.6f %.6f %.2f\n", n, t_selection, t_quick, t_selection/t_quick);
        fclose(f);
        printf("\n–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ —Ñ–∞–π–ª 'benchmark_results.txt'\n");
    }

    // –û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏
    queue_free(&q1);
    queue_free(&q2);
}

/*
 * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∑–∞—Ä–∞–Ω–µ–µ –∑–∞–¥–∞–Ω–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–∞—Ö
 * –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç JSON —Ñ–∞–π–ª –¥–ª—è Python-–≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –≤ –ø–∞–ø–∫–µ benchmark_results/
 */
void benchmark_automated(void)
{
    printf("–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏\n");
    printf("================================================\n\n");
    
    // –°–æ–∑–¥–∞—ë–º –ø–∞–ø–∫—É –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤, –µ—Å–ª–∏ –µ—ë –Ω–µ—Ç
    #ifdef _WIN32
    if (_mkdir("benchmark_results") != 0) {
        // –ï—Å–ª–∏ –ø–∞–ø–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —ç—Ç–æ –Ω–µ –æ—à–∏–±–∫–∞
        if (errno != EEXIST) {
            printf("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–∫–∏ benchmark_results\n");
            return;
        }
    }
    #else
    if (mkdir("benchmark_results", 0755) != 0) {
        // –ï—Å–ª–∏ –ø–∞–ø–∫–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, —ç—Ç–æ –Ω–µ –æ—à–∏–±–∫–∞
        if (errno != EEXIST) {
            printf("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø–∞–ø–∫–∏ benchmark_results\n");
            return;
        }
    }
    #endif
    
    // –§–æ—Ä–º–∏—Ä—É–µ–º –∏–º—è —Ñ–∞–π–ª–∞ —Å –≤—Ä–µ–º–µ–Ω–Ω–æ–π –º–µ—Ç–∫–æ–π
    char json_filename[256];
    char timestamp[64];
    time_t now = time(NULL);
    struct tm *t = localtime(&now);
    strftime(timestamp, sizeof(timestamp), "%Y%m%d_%H%M%S", t);
    snprintf(json_filename, sizeof(json_filename), 
             "benchmark_results/benchmark_%s.json", timestamp);
    
    // –°–æ–∑–¥–∞–Ω–∏–µ JSON —Ñ–∞–π–ª–∞ –¥–ª—è Python
    FILE *f_json = fopen(json_filename, "w");
    if (!f_json) {
        printf("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ñ–∞–π–ª–∞ %s\n", json_filename);
        return;
    }
    
    // –ó–∞–≥–æ–ª–æ–≤–æ–∫ JSON
    fprintf(f_json, "{\n");
    fprintf(f_json, "  \"title\": \"–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –æ—á–µ—Ä–µ–¥–∏\",\n");
    fprintf(f_json, "  \"description\": \"–†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ —Ä–∞–∑–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–∞—Ö –¥–∞–Ω–Ω—ã—Ö\",\n");
    fprintf(f_json, "  \"timestamp\": \"%s\",\n", timestamp);
    fprintf(f_json, "  \"algorithm_names\": {\n");
    fprintf(f_json, "    \"selection\": \"–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤—ã–±–æ—Ä–æ–º (O(n¬≤))\",\n");
    fprintf(f_json, "    \"quick\": \"–ë—ã—Å—Ç—Ä–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ (O(n log n))\"\n");
    fprintf(f_json, "  },\n");
    fprintf(f_json, "  \"sizes\": [");
    
    // –ú–∞—Å—Å–∏–≤ —Ä–∞–∑–º–µ—Ä–æ–≤ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
    size_t sizes[] = {100, 500, 1000, 5000, 10000, 20000, 50000, 75000, 100000, 150000, 200000};
    int num_sizes = sizeof(sizes) / sizeof(sizes[0]);
    
    // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–µ –º–∞—Å—Å–∏–≤—ã –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    double *selection_times = (double*)malloc(num_sizes * sizeof(double));
    double *quick_times = (double*)malloc(num_sizes * sizeof(double));
    double *ratios = (double*)malloc(num_sizes * sizeof(double));
    
    if (!selection_times || !quick_times || !ratios) {
        printf("‚ùå –û—à–∏–±–∫–∞ –≤—ã–¥–µ–ª–µ–Ω–∏—è –ø–∞–º—è—Ç–∏ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤\n");
        fclose(f_json);
        free(selection_times);
        free(quick_times);
        free(ratios);
        return;
    }
    
    printf("–ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ –¥–ª—è %d —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ä–∞–∑–º–µ—Ä–æ–≤...\n\n", num_sizes);
    
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä—ã –≤ JSON
    for (int i = 0; i < num_sizes; i++) {
        fprintf(f_json, "%zu", sizes[i]);
        if (i < num_sizes - 1) fprintf(f_json, ", ");
    }
    fprintf(f_json, "],\n");
    
    // –ù–∞—á–∏–Ω–∞–µ–º –º–∞—Å—Å–∏–≤—ã —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏
    fprintf(f_json, "  \"selection_sort\": [");
    fclose(f_json);
    
    // –¶–∏–∫–ª –ø–æ –≤—Å–µ–º —Ä–∞–∑–º–µ—Ä–∞–º
    for (int i = 0; i < num_sizes; i++) {
        size_t n = sizes[i];
        printf("üîç –¢–µ—Å—Ç %d/%d: —Ä–∞–∑–º–µ—Ä = %zu\n", i+1, num_sizes, n);
        
        Queue q1, q2;
        queue_init(&q1);
        queue_init(&q2);
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–∞ —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª
        srand((unsigned)time(NULL) + i);
        printf("   ‚îú‚îÄ‚îÄ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è %zu —Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª... ", n);
        fflush(stdout);
        
        for (size_t j = 0; j < n; ++j) {
            int val = rand() % 1000000;
            queue_push(&q1, val);
            queue_push(&q2, val);
        }
        printf("‚úì\n");
        
        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –≤—ã–±–æ—Ä–æ–º
        printf("   ‚îú‚îÄ‚îÄ –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –≤—ã–±–æ—Ä–æ–º... ");
        fflush(stdout);
        clock_t start = clock();
        queue_selection_sort(&q1);
        clock_t end = clock();
        double t_selection = (double)(end - start) / CLOCKS_PER_SEC;
        
        // –ï—Å–ª–∏ –≤—Ä–µ–º—è —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–æ–µ, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        if (t_selection < 0.000001) t_selection = 0.000001;
        printf("%.6f —Å–µ–∫ ‚úì\n", t_selection);
        
        // –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –±—ã—Å—Ç—Ä–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        printf("   ‚îú‚îÄ‚îÄ –ë—ã—Å—Ç—Ä–∞—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞... ");
        fflush(stdout);
        start = clock();
        queue_quick_sort(&q2);
        end = clock();
        double t_quick = (double)(end - start) / CLOCKS_PER_SEC;
        
        // –ï—Å–ª–∏ –≤—Ä–µ–º—è —Å–ª–∏—à–∫–æ–º –º–∞–ª–µ–Ω—å–∫–æ–µ, —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ
        if (t_quick < 0.000001) t_quick = 0.000001;
        printf("%.6f —Å–µ–∫ ‚úì\n", t_quick);
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
        selection_times[i] = t_selection;
        quick_times[i] = t_quick;
        
        // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ –æ—Ç–Ω–æ—à–µ–Ω–∏—è —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–µ–ª–µ–Ω–∏—è –Ω–∞ –Ω–æ–ª—å
        if (t_quick > 0.000001) {
            ratios[i] = t_selection / t_quick;
        } else {
            ratios[i] = 0.0;
        }
        
        printf("   ‚îî‚îÄ‚îÄ –û—Ç–Ω–æ—à–µ–Ω–∏–µ: %.2f:1\n\n", ratios[i]);
        
        // –û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º —Ç–µ—Å—Ç–æ–º
        queue_free(&q1);
        queue_free(&q2);
    }
    
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –≤—ã–±–æ—Ä–æ–º –≤ JSON
    f_json = fopen(json_filename, "a");
    if (f_json) {
        for (int i = 0; i < num_sizes; i++) {
            fprintf(f_json, "%.6f", selection_times[i]);
            if (i < num_sizes - 1) fprintf(f_json, ", ");
        }
        fprintf(f_json, "],\n");
        fprintf(f_json, "  \"quick_sort\": [");
        fclose(f_json);
    }
    
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –±—ã—Å—Ç—Ä–æ–π —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    f_json = fopen(json_filename, "a");
    if (f_json) {
        for (int i = 0; i < num_sizes; i++) {
            fprintf(f_json, "%.6f", quick_times[i]);
            if (i < num_sizes - 1) fprintf(f_json, ", ");
        }
        fprintf(f_json, "],\n");
        fprintf(f_json, "  \"ratios\": [");
        fclose(f_json);
    }
    
    // –ó–∞–ø–∏—Å—ã–≤–∞–µ–º –æ—Ç–Ω–æ—à–µ–Ω–∏—è
    f_json = fopen(json_filename, "a");
    if (f_json) {
        for (int i = 0; i < num_sizes; i++) {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
            if (ratios[i] != ratios[i] || ratios[i] < 0 || ratios[i] > 1e100) {
                fprintf(f_json, "0.0");
            } else {
                fprintf(f_json, "%.2f", ratios[i]);
            }
            
            if (i < num_sizes - 1) fprintf(f_json, ", ");
        }
        fprintf(f_json, "]\n");
        fprintf(f_json, "}\n");
        fclose(f_json);
    }
    
    // –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –ø–∞–º—è—Ç–∏
    free(selection_times);
    free(quick_times);
    free(ratios);
    
    printf("‚úÖ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ!\n");
    printf("üìä –î–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤: '%s'\n\n", json_filename);
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Å–ª–µ–¥–Ω–µ–µ –∏–º—è —Ñ–∞–π–ª–∞ –¥–ª—è Python —Å–∫—Ä–∏–ø—Ç–∞
    FILE *f_last = fopen("benchmark_results/last_benchmark.txt", "w");
    if (f_last) {
        fprintf(f_last, "%s", json_filename);
        fclose(f_last);
    }
    
    // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
    printf("–î–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:\n");
    printf("   python plot_benchmark_results.py\n\n");
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ Python —Å–∫—Ä–∏–ø—Ç–∞
    FILE *test_py = fopen("plot_benchmark_results.py", "r");
    if (test_py) {
        fclose(test_py);
        printf("üìà –•–æ—Ç–∏—Ç–µ —Å—Ä–∞–∑—É —Å–æ–∑–¥–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏? (y/n): ");
        
        int answer = getchar();
        if (answer == 'y' || answer == 'Y') {
            printf("\n–ó–∞–ø—É—Å–∫ Python —Å–∫—Ä–∏–ø—Ç–∞...\n");
            #ifdef _WIN32
            system("python plot_benchmark_results.py");
            #else
            system("python3 plot_benchmark_results.py");
            #endif
        }
    } else {
        printf("‚ö†Ô∏è  –§–∞–π–ª 'plot_benchmark_results.py' –Ω–µ –Ω–∞–π–¥–µ–Ω.\n");
        printf("   –°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤.\n");
    }
}